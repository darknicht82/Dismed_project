{% extends 'base.html' %}

{% block title %}
Estimación para {{ unidad.nombre_unidad }}
{% endblock %}

{% block content %}
  <h1>Estimación de Dispositivos Médicos</h1>
  <h2>{{ unidad.nombre_unidad }}</h2>
  <div class="table-responsive">
    <form method="post">
      {% csrf_token %}
      <table class="table table-striped table-hover align-middle mb-0 bg-white">
        <thead class="thead-dark">
            <tr>
              <th colspan="32"></th>
              <th colspan="3" style="background-color: #FFD966;" class="text-center align-middle">CRITERIOS DE ANÁLISIS PREVIO AL PLAN DE COMPRA</th>
              <th colspan="6" style="background-color: #FFD966;" class="text-center align-middle">CRONOGRAMA DE ADQUISICIONES</th>
              <th style="background-color: #8497B0;" class="text-center align-middle">EJECUCIÓN PRESUPUESTARIA</th>
              <th>&nbsp;</th>
            </tr>
            <tr>
              <th colspan="12"></th>
              <th colspan="6" style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">NIVEL DE ATENCIÓN</th>
              <th colspan="5">&nbsp;</th>
              <th colspan="2" style="background-color: #FFC7CE;" class="text-center align-middle">CANTIDAD EN PROCESO DE ADQUISICIÓN (ADJUDICADO)</th>
              <th colspan="2">&nbsp;</th>
              <th colspan="3" style="background-color: #FFFF00;" class="text-center align-middle">REQUERIMIENTO PARA PROGRAMACIÓN</th>
              <th colspan="2">&nbsp;</th>
              <th rowspan="2" style="background-color: #FFE699;" class="text-center align-middle">Disponibilidad de Dispositivo Médico</th>
              <th rowspan="2" style="background-color: #FFE699;" class="text-center align-middle">Nivel de Abastecimiento</th>
              <th rowspan="2" style="background-color: #FFE699;" class="text-center align-middle">Tipo de Procedimiento de Contratación Pública</th>
              <th colspan="2" style="background-color: #FFF2CC;" class="text-center align-middle">
                Primer Cuatrimestre<br />
                (entre Enero - Abril)
              </th>
              <th colspan="2" style="background-color: #FFF2CC;" class="text-center align-middle">
                Segundo Cuatrimestre<br />
                (entre Mayo - Agosto)
              </th>
              <th colspan="2" style="background-color: #FFF2CC;" class="text-center align-middle">
                Tercer Cuatrimestre<br />
                ( entre Septiembre - Diciembre)
              </th>
              <th rowspan="2" style="background-color: #8497B0;" class="text-center align-middle">Priorización</th>
              <th rowspan="2" style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Observaciones</th>
            </tr>
            <tr>
              <th class="bgstickhead" style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Acción</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">N° ítem</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Nombre Subcomité</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">N° Partida Presupuestaria</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Nombre Partida Presupuestaria</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">CUDIM de referencia</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Código IESS</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Código AS400</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Nombre Genérico</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Especificación Técnica</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Presentación Unidad de Medida</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Nivel de Riesgo Sugerido</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">IA</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">IB</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">IC</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">II</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">III</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">APH</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Especialidad/Subespecialidad</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Consumo Promedio Proyectado(CPP)</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Periodicidad de Consumo(PC)</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Saldo en Bodega Actual(SBA)</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Proyección de Saldo</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Cantidad Pendiente de Entrega(CPE)</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Código de Proceso</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Requerimiento Total Proyectado(RTP)</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Stock de Seguridad(SS)</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Cantidad a Programar Inicialmente(CPI)</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Cantidad de Devolución por Préstamo(CDP)</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Cantidad Final a Requerir(CFR)</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Precio Unitario Referencial(PUR)</th>
              <th style="background-color: #5B9BD5; color: #fff;" class="text-center align-middle">Precio Referencial Total(PRT)</th>
              <th style="background-color: #FFF2CC;" class="text-center align-middle">Cantidad</th>
              <th style="background-color: #FFF2CC;" class="text-center align-middle">Monto</th>
              <th style="background-color: #FFF2CC;" class="text-center align-middle">Cantidad</th>
              <th style="background-color: #FFF2CC;" class="text-center align-middle">Monto</th>
              <th style="background-color: #FFF2CC;" class="text-center align-middle">Cantidad</th>
              <th style="background-color: #FFF2CC;" class="text-center align-middle">Monto</th>
            </tr>
          </thead>
        <tbody>
          {% for dispositivo in dispositivos %}
            <tr>
              <td class="text-center align-middle">
                <button type="button" class="btn btn-warning btn-sm editar-btn" data-id="{{ dispositivo.id }}">Editar</button>
                <button type="button" class="btn btn-sm btn-danger">Eliminar</button>
              </td>
                <td class="text-center align-middle">{{ dispositivo.item_nro }}</td>
                <td class="align-middle cell220">{{ dispositivo.nom_subcomite }}</td>
                <td class="text-center align-middle">{{ dispositivo.nro_partida_pres }}</td>
                <td class="align-middle cell260">{{ dispositivo.nom_partida_pres }}</td>
                <td class="text-center align-middle cell200">{{ dispositivo.cudim }}</td>
                <td class="text-center align-middle cell120">{{ dispositivo.cod_iess }}</td>
                <td class="text-center align-middle">{{ dispositivo.cod_as400 }}</td>
                <td class="align-middle cell220">{{ dispositivo.nom_generico }}</td>
                <td class="especTecCell align-middle cell310">
                  <span class="text-content truncate">{{ dispositivo.espec_tec }}</span>
                  <a href="#" class="toggleText btn btn-info btn-rounded btn-sm">Leer más</a>
                </td>
                <td class="text-center align-middle">{{ dispositivo.pres_unimed }}</td>
                <td class="text-center align-middle">{{ dispositivo.lvl_riesgo_suger }}</td>
                <td class="text-center align-middle">{{ dispositivo.lvl_aten_ia }}</td>
                <td class="text-center align-middle">{{ dispositivo.lvl_aten_ib }}</td>
                <td class="text-center align-middle">{{ dispositivo.lvl_aten_ic }}</td>
                <td class="text-center align-middle">{{ dispositivo.lvl_aten_ii }}</td>
                <td class="text-center align-middle">{{ dispositivo.lvl_aten_iii }}</td>
                <td class="text-center align-middle">{{ dispositivo.lvl_aten_aph }}</td>
                <td class="text-center align-middle">{{ dispositivo.espec_subespec }}</td>

              <!-- Campos Editables para Prepriorización -->
              <td class="text-center align-middle">
                <input type="number" name="consumo_prom_proyec_{{ dispositivo.id }}" required>
              </td>
              <td class="text-center align-middle">
                <select name="perioci_consumo_{{ dispositivo.id }}" required>
                  {% for periodo in periodos %}
                    <option value="{{ periodo.id }}">{{ periodo.periodicidad }}</option>
                  {% endfor %}
                </select>
              </td>
              <td class="text-center align-middle">
                <input type="number" name="saldo_bodega_actual_{{ dispositivo.id }}">
              </td>
              <td class="text-center align-middle">{{ dispositivo.proyecc_saldo }}</td>
              <td class="text-center align-middle">
                <input type="number" name="cant_pend_entre_{{ dispositivo.id }}">
              </td>
              <td class="text-center align-middle">
                <input type="text" pattern="[A-Za-z0-9-]+" name="cod_proceso_{{ dispositivo.id }}">
              </td>
              <td class="text-center align-middle">{{ dispositivo.req_total_proyectado }}</td>
              <td class="text-center align-middle">{{ dispositivo.stock_seguridad }}</td>
              <td class="text-center align-middle">{{ dispositivo.cant_program_inicial }}</td>
              <td class="text-center align-middle">
                <input type="number" name="cant_devol_prestam_{{ dispositivo.id }}">
              </td>
              <td class="text-center align-middle">{{ dispositivo.cant_final_required }}</td>
              <td class="text-center align-middle">
                <input
                    type="text"
                    class="currency-input"
                    name="prec_unit_ref_{{ dispositivo.id }}"
                    id="prec_unit_ref_{{ dispositivo.id }}"
                    pattern="^USD\s?\d{1,3}(,\d{3})*(\.\d{4})?$"
                    required
                    onfocusout="formatCurrencyInput(this, 4)"
                >
              </td>
              <td class="text-center align-middle">USD {{ dispositivo.pres_ref_total|floatformat:2 }}</td>
              <td class="text-center align-middle">{{ dispositivo.dispo_dm }}</td>
              <td class="text-center align-middle">{{ dispositivo.lvl_abastec }}</td>
              <td class="text-center align-middle">
                <select name="tip_proc_cp_{{ dispositivo.id }}">
                  <option value="infima_cuantia">Ínfima Cuantía</option>
                  <option value="subasta_inversa">Subasta Inversa</option>
                  <option value="regimen_especial">Régimen Especial</option>
                </select>
              </td>
              <td class="text-center align-middle">{{ dispositivo.prim_cuatri_cant }}</td>
              <td class="text-center align-middle">USD {{ dispositivo.prim_cuatri_mont|floatformat:2 }}</td>
              <td class="text-center align-middle">{{ dispositivo.seg_cuatri_cant }}</td>
              <td class="text-center align-middle">USD {{ dispositivo.seg_cuatri_mont|floatformat:2 }}</td>
              <td class="text-center align-middle">{{ dispositivo.terc_cuatri_cant }}</td>
              <td class="text-center align-middle">USD {{ dispositivo.terc_cuatri_mont|floatformat:2 }}</td>
              <td class="text-center align-middle">
                <input type="checkbox" name="priorizacion_{{ dispositivo.id }}">
              </td>
              <td class="align-middle">
                <input type="text" maxlength="500" name="observaciones_{{ dispositivo.id }}">
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <button type="submit" class="btn btn-primary mt-3">Guardar cambios</button>
    </form>
  </div>
<!-- Agrega el script para la función formatCurrencyInput -->
<script>
  function formatCurrencyInput(input, decimals) {
      // Obtener el valor actual del campo de entrada
      let value = input.value;
      // Remover caracteres no numéricos y reemplazar coma con nada
      value = value.replace(/[^\d,]/g, '');
      
      // Obtener las partes enteras y decimales del valor
      let parts = value.split(',');
      let wholePart = parts[0];
      let decimalPart = parts[1] || '';

      // Añadir ceros al final de los decimales si es necesario
      if (decimalPart.length < decimals) {
          decimalPart = decimalPart + '0'.repeat(decimals - decimalPart.length);
      } else if (decimalPart.length > decimals) {
          decimalPart = decimalPart.substring(0, decimals);
      }

      // Formatear el valor con el punto para miles y coma para decimales
      let formattedValue = "USD " + wholePart.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ',' + decimalPart;

      // Actualizar el valor del campo de entrada con el valor formateado
      input.value = formattedValue;
  }
</script>



<script>
  $(document).ready(function() {
    $('.editar-btn').click(function() {
      const dispositivoId = $(this).data('id');
      $.ajax({
        url: `/obtener_datos_dispositivo/${dispositivoId}/`, // URL de la vista que devuelve los datos del dispositivo en formato JSON
        method: 'GET',
        success: function(data) {
          // Aquí puedes llenar un formulario con los datos recibidos y mostrarlo para edición
          // Por ejemplo, puedes llenar los campos de un modal
          $('#editModal').modal('show');
          $('#consumo_prom_proyec_input').val(data.consumo_prom_proyec);
          $('#perioci_consumo_select').val(data.perioci_consumo);
          $('#saldo_bodega_actual_').val(data.consumo_prom_proyec);
          $('#consumo_prom_proyec_input').val(data.consumo_prom_proyec);
          $('#consumo_prom_proyec_input').val(data.consumo_prom_proyec);
          $('#consumo_prom_proyec_input').val(data.consumo_prom_proyec);
          $('#consumo_prom_proyec_input').val(data.consumo_prom_proyec);
          $('#consumo_prom_proyec_input').val(data.consumo_prom_proyec);
        },
        error: function() {
          // Manejo de errores
        }
      });
    });
  });
</script>

{% endblock %}
